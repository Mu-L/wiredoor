[SERVICE]
    Parsers_File      parsers.conf

[INPUT]
    Name              nginx_metrics
    Tag               nginx.status
    status_url        http://127.0.0.1/nginx_status
    nginx_plus        Off

[INPUT]
    Name              tail
    Path              /var/log/nginx/access.log
    Parser            nginx_access
    Tag               nginx.http.default
    Refresh_Interval  5
    Multiline         Off

[INPUT]
    Name              tail
    Path              /var/log/nginx/stream.log
    Parser            nginx_stream
    Tag               nginx.stream.default
    Refresh_Interval  5
    Multiline         Off

[INPUT]
    Name              tail
    Path              /var/log/nginx/*/access.log
    Parser            nginx_access
    Tag               nginx.http.domain.*
    Refresh_Interval  5
    Multiline         Off

[INPUT]
    Name              tail
    Path              /var/log/nginx/*/oauth2-proxy.stdout.log
    Parser            oauth2_proxy_access
    Tag               nginx.oauth2.domain.*
    Refresh_Interval  5
    Multiline         Off

[INPUT]
    Name              tail
    Path              /var/log/nginx/*/*_stream.log
    Parser            nginx_stream
    Tag               nginx.stream.domain.*
    Refresh_Interval  5
    Multiline         Off

[FILTER]
    Name   grep
    Match  nginx.*
    Exclude remote ^127\.0\.0\.1$

[FILTER]
    Name lua
    Match nginx.http.*
    script lua/extract_domain.lua
    call extract_domain_http

[FILTER]
    Name lua
    Match nginx.stream.*
    script lua/extract_domain.lua
    call extract_domain_stream

[FILTER]
    Name lua
    Match nginx.http.*
    script lua/normalize_http_log.lua
    call normalize

[FILTER]
    Name lua
    Match nginx.stream.*
    script lua/normalize_tcp_log.lua
    call normalize

[FILTER]
    Name   lua
    Match  nginx.oauth2.domain.*
    Script lua/normalize_oauth2_log.lua
    Call   normalize

[FILTER]
    Name   lua
    Match  nginx.http.*
    script lua/sanitize_path.lua
    call   strip_query

[FILTER]
    Name   lua
    Match  nginx.oauth2.domain.*
    Script lua/oauth2.lua
    Call   filter_valid_email

[FILTER]
    Name               log_to_metrics
    Match              nginx.http.*
    Tag                http_requests
    metric_name        http_requests_total
    metric_mode        counter
    value_field        status
    label_field        status
    add_label          domain domain
    add_label          remote remote
    add_label          user user
    add_label          method method
    add_label          path path
    add_label          protocol protocol
    metric_description Total HTTP requests per status code

[FILTER]
    Name               log_to_metrics
    Match              nginx.http.*
    Tag                http_response_size
    metric_name        http_response_bytes
    metric_mode        gauge
    value_field        size
    label_field        path
    add_label          remote remote
    add_label          user user
    add_label          method method
    add_label          status status
    add_label          protocol protocol
    metric_description HTTP response body size

[FILTER]
    Name               log_to_metrics
    Match              nginx.oauth2.domain.*
    Tag                oauth2_requests
    metric_name        oauth2_requests_total
    metric_mode        counter
    value_field        status
    label_field        status
    add_label          path path
    add_label          host host
    add_label          method method
    metric_description Total OAuth2 requests

[FILTER]
    Name               log_to_metrics
    Match              nginx.oauth2.domain.*
    Tag                oauth2_duration
    metric_name        oauth2_request_duration_seconds
    metric_mode        gauge
    value_field        request_time
    label_field        path
    add_label          host host
    add_label          method method
    add_label          status status
    metric_description OAuth2 request duration

[FILTER]
    Name               log_to_metrics
    Match              nginx.oauth2.domain.*
    Tag                oauth2_size
    metric_name        oauth2_response_size_bytes
    metric_mode        gauge
    value_field        size
    label_field        path
    add_label          host host
    add_label          method method
    add_label          status status
    metric_description OAuth2 response size

[FILTER]
    Name               log_to_metrics
    Match              nginx.oauth2.domain.*
    Tag                oauth2_requests_by_email
    metric_name        oauth2_requests_total_by_email
    metric_mode        counter
    value_field        status
    label_field        email
    add_label          path path
    add_label          host host
    add_label          method method
    metric_description OAuth2 requests by authenticated email

[OUTPUT]
    Name              prometheus_exporter
    Match             *
    Host              0.0.0.0
    Port              2020

[OUTPUT]
    Name  stdout
    Match nginx.oauth2.*
    Format json_lines