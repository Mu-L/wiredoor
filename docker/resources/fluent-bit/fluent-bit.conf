[SERVICE]
    Parsers_File       parsers.conf

[INPUT]
    Name               nginx_metrics
    Tag                nginx.status
    Status_Url         http://127.0.0.1/nginx_status
    Nginx_Plus         Off

[INPUT]
    Name               tail
    Path               /var/log/nginx/access.log
    Parser             nginx_access
    Tag                nginx.http.default
    Refresh_Interval   5
    Multiline          Off

[INPUT]
    Name               tail
    Path               /var/log/nginx/stream.log
    Parser             nginx_stream
    Tag                nginx.stream.default
    Refresh_Interval   5
    Multiline          Off

[INPUT]
    Name               tail
    Path               /var/log/nginx/*/access.log
    Parser             nginx_access
    Tag                nginx.http.domain.*
    Refresh_Interval   5
    Multiline          Off

[INPUT]
    Name               tail
    Path               /var/log/nginx/*/oauth2-proxy.stdout.log
    Parser             oauth2_proxy_access
    Tag                nginx.oauth2.domain.*
    Refresh_Interval   5
    Multiline          Off

[INPUT]
    Name               tail
    Path               /var/log/nginx/*/*_stream.log
    Parser             nginx_stream
    Tag                nginx.stream.domain.*
    Refresh_Interval   5
    Multiline          Off
    
[FILTER]
    Name               grep
    Match              nginx.*
    Exclude            remote ^127\.0\.0\.1$

[FILTER]
    Name    modify
    Match   nginx.http.*
    Convert status string

[FILTER]
    Name               lua
    Match              nginx.http.*
    Script             lua/extract_domain.lua
    Call               extract_domain_http

[FILTER]
    Name               lua
    Match              nginx.stream.*
    Script             lua/extract_domain.lua
    Call               extract_domain_stream

[FILTER]
    Name               lua
    Match              nginx.http.*
    Script             lua/normalize_http_log.lua
    Call               normalize

[FILTER]
    Name               lua
    Match              nginx.stream.*
    Script             lua/normalize_tcp_log.lua
    Call               normalize

[FILTER]
    Name               lua
    Match              nginx.oauth2.domain.*
    Script             lua/normalize_oauth2_log.lua
    Call               normalize

[FILTER]
    Name               lua
    Match              nginx.http.*
    Script             lua/sanitize_path.lua
    Call               strip_query

[FILTER]
    Name               lua
    Match              nginx.oauth2.domain.*
    Script             lua/oauth2.lua
    Call               filter_valid_email

[FILTER]
    Name               log_to_metrics
    Match              nginx.http.*
    Tag                http_requests
    Metric_Name        http_requests_total
    Metric_Mode        counter
    Value_Field        status
    Label_Field        status
    Add_Label          domain domain
    Add_Label          host host
    Add_Label          user user
    Add_Label          method method
    Metric_Description Total HTTP requests per status code

[FILTER]
    Name               log_to_metrics
    Match              nginx.http.*
    Tag                http_response_bytes
    Metric_Name        http_response_bytes
    Metric_Mode        gauge
    Value_Field        size
    Label_Field        domain
    Add_Label          host host
    Add_Label          method method
    Add_Label          status status
    Metric_Description HTTP response body size

[FILTER]
    Name               log_to_metrics
    Match              nginx.oauth2.domain.*
    Tag                oauth2_requests
    Metric_Name        oauth2_requests_total
    Metric_Mode        counter
    Value_Field        status
    Label_Field        email
    Add_Label          host host
    Metric_Description Total OAuth2 requests

[FILTER]
    Name               log_to_metrics
    Match              nginx.stream.*
    Tag                tcp_sessions
    Metric_Name        tcp_sessions_total
    Metric_Description TCP sessions by domain
    Metric_Mode        counter
    Value_Field        status
    Label_Field        domain
    Add_Label          backend upstream_addr

[OUTPUT]
    Name              prometheus_exporter
    Match             *
    Host              0.0.0.0
    Port              2020

# [OUTPUT]
#     Name  stdout
#     Match system.*
#     Format json_lines