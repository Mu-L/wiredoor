[SERVICE]
    Parsers_File       parsers.conf

[INPUT]
    Name               mem
    Tag                system.mem

[INPUT]
    Name               cpu
    Tag                system.cpu

[INPUT]
    Name               netif
    Tag                system.net.wg0
    Interface          wg0
    Interval_Sec       5

[INPUT]
    Name               netif
    Tag                system.net.eth0
    Interface          eth0
    Interval_Sec       5

[INPUT]
    Name               nginx_metrics
    Tag                nginx.status
    Status_Url         http://127.0.0.1/nginx_status
    Nginx_Plus         Off

[INPUT]
    Name               tail
    Path               /var/log/nginx/access.log
    Parser             nginx_access
    Tag                nginx.http.default
    Refresh_Interval   5
    Multiline          Off

[INPUT]
    Name               tail
    Path               /var/log/nginx/stream.log
    Parser             nginx_stream
    Tag                nginx.stream.default
    Refresh_Interval   5
    Multiline          Off

[INPUT]
    Name               tail
    Path               /var/log/nginx/*/access.log
    Parser             nginx_access
    Tag                nginx.http.domain.*
    Refresh_Interval   5
    Multiline          Off

[INPUT]
    Name               tail
    Path               /var/log/nginx/*/oauth2-proxy.stdout.log
    Parser             oauth2_proxy_access
    Tag                nginx.oauth2.domain.*
    Refresh_Interval   5
    Multiline          Off

[INPUT]
    Name               tail
    Path               /var/log/nginx/*/*_stream.log
    Parser             nginx_stream
    Tag                nginx.stream.domain.*
    Refresh_Interval   5
    Multiline          Off

[FILTER]
    Name               log_to_metrics
    Match              system.cpu
    Tag                node_cpu_utilization_percent
    Metric_Name        node_cpu_utilization_percent
    Metric_Mode        gauge
    Value_Field        cpu_p
    Add_Label          cpu total
    Metric_Description Total CPU usage percent (aggregate)

[FILTER]
    Name               log_to_metrics
    Match              system.mem
    Tag                node_memory_used_bytes
    Metric_Name        node_memory_used_bytes
    Metric_Mode        gauge
    Value_Field        Mem.used
    Metric_Description Memory used in bytes

[FILTER]
    Name               log_to_metrics
    Match              system.mem
    Tag                node_memory_total_bytes
    Metric_Name        node_memory_total_bytes
    Metric_Mode        gauge
    Value_Field        Mem.total
    Metric_Description Memory total in bytes

# [FILTER]
#     Name               log_to_metrics
#     Match              system.net.eth0
#     Tag                system.net.eth0
#     Metric_Name        net_bytes_sent
#     Metric_Mode        gauge
#     Value_Field        eth0.tx.bytes
#     Add_Label          interface interface
#     Metric_Description Total bytes transmitted on eth0 interface

# [FILTER]
#     Name               log_to_metrics
#     Match              system.net.eth0
#     Tag                system.net.eth0
#     Metric_Name        net_bytes_recv
#     Metric_Mode        gauge
#     Value_Field        eth0.rx.bytes
#     Add_Label          interface interface
#     Metric_Description Total bytes recieved on eth0 interface
    
[FILTER]
    Name               grep
    Match              nginx.*
    Exclude            remote ^127\.0\.0\.1$

[FILTER]
    Name               lua
    Match              nginx.http.*
    Script             lua/extract_domain.lua
    Call               extract_domain_http

[FILTER]
    Name               lua
    Match              nginx.stream.*
    Script             lua/extract_domain.lua
    Call               extract_domain_stream

[FILTER]
    Name               lua
    Match              nginx.http.*
    Script             lua/normalize_http_log.lua
    Call               normalize

[FILTER]
    Name               lua
    Match              nginx.stream.*
    Script             lua/normalize_tcp_log.lua
    Call               normalize

[FILTER]
    Name               lua
    Match              nginx.oauth2.domain.*
    Script             lua/normalize_oauth2_log.lua
    Call               normalize

[FILTER]
    Name               lua
    Match              nginx.http.*
    Script             lua/sanitize_path.lua
    Call               strip_query

[FILTER]
    Name               lua
    Match              nginx.oauth2.domain.*
    Script             lua/oauth2.lua
    Call               filter_valid_email

[FILTER]
    Name               log_to_metrics
    Match              nginx.http.*
    Tag                http_requests
    Metric_Name        http_requests_total
    Metric_Mode        counter
    Value_Field        status
    Label_Field        status
    Add_Label          domain domain
    Add_Label          user user
    Add_Label          method method
    Metric_Description Total HTTP requests per status code

[FILTER]
    Name               log_to_metrics
    Match              nginx.http.*
    Tag                http_response_bytes
    Metric_Name        http_response_bytes
    Metric_Mode        gauge
    Value_Field        size
    Label_Field        domain
    Add_Label          method method
    Add_Label          status status
    Metric_Description HTTP response body size

[FILTER]
    Name               log_to_metrics
    Match              nginx.oauth2.domain.*
    Tag                oauth2_requests
    Metric_Name        oauth2_requests_total
    Metric_Mode        counter
    Value_Field        status
    Label_Field        email
    Add_Label          host host
    Metric_Description Total OAuth2 requests

[FILTER]
    Name               log_to_metrics
    Match              nginx.stream.*
    Tag                tcp_sessions
    Metric_Name        tcp_sessions_total
    Metric_Description TCP sessions by domain
    Metric_Mode        counter
    Value_Field        status
    Label_Field        domain
    Add_Label          backend upstream_addr

[OUTPUT]
    Name              prometheus_exporter
    Match             *
    Host              0.0.0.0
    Port              2020

[OUTPUT]
    Name  stdout
    Match system.*
    Format json_lines